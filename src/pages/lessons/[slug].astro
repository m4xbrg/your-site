---
import DocsLayout from "../../layouts/DocsLayout.astro"
import { getCollection } from 'astro:content'
import { collectionNames } from "../../lib/collections"

type MetadataItem = {
  label: string
  value: string
  href?: string
}

const formatDuration = (minutes?: number) =>
  typeof minutes === 'number' ? `${minutes} min` : undefined

export async function getStaticPaths() {
  const lessons = await getCollection(collectionNames.lessons)
  return lessons.map((lesson) => ({
    params: {
      slug: lesson.slug.includes('/') ? lesson.slug.split('/') : lesson.slug,
    },
    props: { lesson },
  }))
}

const { lesson } = Astro.props
if (!lesson) throw new Error('Lesson not found')
const { Content } = await lesson.render()
const durationLabel = formatDuration(lesson.data.durationMinutes)
const metadata = (
  [
    lesson.data.course && {
      label: 'Course',
      value: lesson.data.course,
      href: `/courses/${lesson.data.course}/`,
    },
    lesson.data.concept && {
      label: 'Concept',
      value: lesson.data.concept,
      href: `/concepts/${lesson.data.concept}/`,
    },
    durationLabel && {
      label: 'Duration',
      value: durationLabel,
    },
  ].filter(Boolean)
) as MetadataItem[]
---
<DocsLayout title={lesson.data.title} description={lesson.data.description}>
  <article class="prose max-w-none">
    <h1>{lesson.data.title}</h1>
    {lesson.data.description && <p class="text-gray-600">{lesson.data.description}</p>}
    {metadata.length > 0 && (
      <dl class="mt-4 flex flex-wrap gap-4 rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm text-gray-700">
        {metadata.map((item) => (
          <div>
            <dt class="font-semibold text-gray-800">{item.label}</dt>
            <dd>
              {item.href ? (
                <a class="text-brand-600 hover:underline" href={item.href}>
                  {item.value}
                </a>
              ) : (
                <span>{item.value}</span>
              )}
            </dd>
          </div>
        ))}
      </dl>
    )}
    {lesson.data.objectives && lesson.data.objectives.length > 0 && (
      <section class="mt-8">
        <h2 class="text-xl font-semibold">Learning objectives</h2>
        <ul class="list-disc pl-6">
          {lesson.data.objectives.map((objective) => (
            <li>{objective}</li>
          ))}
        </ul>
      </section>
    )}
    <section class="mt-8">
      <Content />
    </section>
  </article>
</DocsLayout>
