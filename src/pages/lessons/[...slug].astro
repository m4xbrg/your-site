---
import DocsLayout from "../../layouts/DocsLayout.astro"
import TagChips from "../../components/TagChips.astro"
import { getCollection } from "astro:content"
import { collectionNames } from "../../lib/collections"

export async function getStaticPaths() {
  const allLessons = await getCollection(collectionNames.lessons)

  return allLessons.map((entry) => ({
    params: { slug: entry.slug },
    props: { lesson: entry },
  }))
}

const { lesson } = Astro.props
if (!lesson) throw new Error("Lesson not found")

const data = lesson.data
const { Content } = await lesson.render()

// naive matching: exercise.data.lessonId === data.id
const allExercises = await getCollection(collectionNames.exercises)
const exercisesForLesson = allExercises.filter(
  (ex) => ex.data.lessonId === data.id,
)

// prev / next within the same course (if you have courseId / course + order)
const allLessons = await getCollection(collectionNames.lessons)
const courseKey = data.courseId ?? data.course
let prevLesson = null
let nextLesson = null

if (courseKey) {
  const lessonsInCourse = allLessons
    .filter((l) => {
      const lKey = l.data.courseId ?? l.data.course
      return lKey === courseKey
    })
    .sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0))

  const idx = lessonsInCourse.findIndex((l) => l.slug === lesson.slug)
  if (idx !== -1) {
    prevLesson = lessonsInCourse[idx - 1] ?? null
    nextLesson = lessonsInCourse[idx + 1] ?? null
  }
}

const durationLabel =
  typeof data.durationMinutes === "number" && data.durationMinutes > 0
    ? `${data.durationMinutes} min`
    : undefined

const hasMetadata =
  !!durationLabel ||
  !!data.course ||
  !!data.courseId ||
  !!data.concept ||
  (Array.isArray(data.concepts) && data.concepts.length > 0) ||
  (Array.isArray(data.objectives) && data.objectives.length > 0)
---

<DocsLayout title={data.title} description={data.description}>
  <article class="prose">
    <header class="mb-6">
      <h1 class="mb-2">{data.title}</h1>
      {data.description && (
        <p class="text-gray-600">{data.description}</p>
      )}
      <div class="mt-3 flex flex-wrap gap-2 items-center">
        {durationLabel && (
          <span class="rounded-full bg-slate-100 px-3 py-1 text-sm font-medium text-slate-700">
            {durationLabel}
          </span>
        )}
        {Array.isArray(data.tags) && data.tags.length > 0 && (
          <TagChips tags={data.tags} />
        )}
      </div>
    </header>

    {hasMetadata && (
      <section class="mb-6 text-sm text-gray-700 space-y-2">
        {(data.course || data.courseId) && (
          <p>
            <strong>Course:</strong>{" "}
            {data.courseId ?? data.course}
          </p>
        )}
        {(data.concept ||
          (Array.isArray(data.concepts) && data.concepts.length)) && (
          <p>
            <strong>Concepts:</strong>{" "}
            {data.concept ?? (data.concepts ?? []).join(", ")}
          </p>
        )}
        {Array.isArray(data.objectives) && data.objectives.length > 0 && (
          <div>
            <strong>Objectives</strong>
            <ul class="list-disc pl-5 mt-1">
              {data.objectives.map((obj) => <li>{obj}</li>)}
            </ul>
          </div>
        )}
      </section>
    )}

    <section class="mt-6">
      <Content />
    </section>

    {exercisesForLesson.length > 0 && (
      <section class="mt-10 border-t pt-6">
        <h2 class="text-lg font-semibold mb-3">Practice for this lesson</h2>
        <ul class="space-y-2">
          {exercisesForLesson.map((ex) => (
            <li>
              <a
                href={`/exercises/${ex.slug}`}
                class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 rounded-lg border px-3 py-2 bg-slate-50 hover:bg-slate-100 transition"
              >
                <span class="font-medium text-sm">
                  {ex.data.title}
                </span>
                <span class="text-xs text-gray-500">
                  {ex.data.status === "draft" ? "Draft" : "Exercises"} ·{" "}
                  {ex.data.concepts?.join(", ")}
                </span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {(prevLesson || nextLesson) && (
      <nav class="mt-8 border-t pt-4 flex flex-wrap gap-3 text-sm text-gray-700">
        {prevLesson && (
          <a
            href={`/lessons/${prevLesson.slug}`}
            class="inline-flex items-center gap-1 hover:underline"
          >
            ← {prevLesson.data.title}
          </a>
        )}
        {nextLesson && (
          <a
            href={`/lessons/${nextLesson.slug}`}
            class="inline-flex items-center gap-1 ml-auto hover:underline"
          >
            {nextLesson.data.title} →
          </a>
        )}
      </nav>
    )}
  </article>
</DocsLayout>
