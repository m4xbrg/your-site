---
import DocsLayout from "../../layouts/DocsLayout.astro"
import TagChips from "../../components/TagChips.astro"
import ExerciseProblems from "../../components/ExerciseProblems.astro"
import { getCollection } from "astro:content"
import { collectionNames } from "../../lib/collections"

export async function getStaticPaths() {
  const allExercises = await getCollection(collectionNames.exercises)

  return allExercises.map((entry) => ({
    params: { slug: entry.slug },
    props: { exercise: entry },
  }))
}

const { exercise } = Astro.props
if (!exercise) throw new Error("Exercise set not found")

const data = exercise.data
const { Content } = await exercise.render()

const hasMeta =
  data.lessonId ||
  data.courseId ||
  data.macroId ||
  (Array.isArray(data.concepts) && data.concepts.length > 0) ||
  data.status ||
  (Array.isArray(data.tags) && data.tags.length > 0)

// Resolve the lesson this exercise set belongs to, based on lessonId
let lessonForExercise = null
if (data.lessonId) {
  const allLessons = await getCollection(collectionNames.lessons)
  lessonForExercise =
    allLessons.find((l) => l.data.id === data.lessonId) ?? null
}
// Resolve course and macro-course
let courseForExercise = null
let macroForExercise = null

if (lessonForExercise) {
  const lessonCourseId = lessonForExercise.data.courseId ?? lessonForExercise.data.course
  if (lessonCourseId) {
    const allCourses = await getCollection(collectionNames.courses)
    courseForExercise = allCourses.find((c) => c.data.id === lessonCourseId)

    if (courseForExercise?.data?.macroId) {
      const allMacros = await getCollection(collectionNames["macro-courses"])
      macroForExercise = allMacros.find((m) => m.data.id === courseForExercise.data.macroId)
    }
  }
}

// Resolve concepts for this exercise
const allConcepts = await getCollection(collectionNames.concepts)

let conceptsForExercise = []

if (Array.isArray(data.concepts)) {
  conceptsForExercise = data.concepts
    .map((idOrSlug) =>
      allConcepts.find(
        (c) => c.data.id === idOrSlug || c.slug === idOrSlug
      ),
    )
    .filter(Boolean)
}

---

<DocsLayout title={data.title} description={data.description}>
  <article class="prose">
    <header class="mb-6">
      <h1 class="mb-2">{data.title}</h1>
      {data.description && (
        <p class="text-gray-600">{data.description}</p>
      )}

      {lessonForExercise && (
        <p class="text-sm text-gray-600 mt-1">
          Related lesson:{" "}
          <a
            href={`/lessons/${lessonForExercise.slug}`}
            class="text-blue-700 hover:underline"
          >
            {lessonForExercise.data.title}
          </a>
        </p>
      )}

      {courseForExercise && (
        <p class="text-sm text-gray-600">
          Course:{" "}
          <a
            href={`/courses/${courseForExercise.data.id}/`}
            class="text-blue-700 hover:underline"
          >
            {courseForExercise.data.title}
          </a>
        </p>
      )}

      {macroForExercise && (
        <p class="text-sm text-gray-600">
          Macro-course:{" "}
          <a
            href={`/macro-courses/${macroForExercise.slug}/`}
            class="text-blue-700 hover:underline"
          >
            {macroForExercise.data.title}
          </a>
        </p>
      )}

      {Array.isArray(data.tags) && data.tags.length > 0 && (
        <TagChips tags={data.tags} class="mt-3" />
      )}

      {conceptsForExercise.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-2">
          {conceptsForExercise.map((concept) => (
            <a
              href={`/concepts/${concept.slug}/`}
              class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-200"
            >
              {concept.data.title}
            </a>
          ))}
        </div>
      )}
    </header>

    {hasMeta && (
      <section class="mb-6 text-sm text-gray-700 space-y-1">
        {data.subject && (
          <p>
            <strong>Subject:</strong> {data.subject}
          </p>
        )}
        {data.macroId && (
          <p>
            <strong>Macro course:</strong> {data.macroId}
          </p>
        )}
        {data.courseId && (
          <p>
            <strong>Course:</strong> {data.courseId}
          </p>
        )}
        {data.lessonId && (
          <p>
            <strong>Lesson ID:</strong> {data.lessonId}
          </p>
        )}
        {Array.isArray(data.concepts) && data.concepts.length > 0 && (
          <p>
            <strong>Concepts:</strong> {data.concepts.join(", ")}</p>
        )}
        {data.status && (
          <p>
            <strong>Status:</strong> {data.status}</p>
        )}
      </section>
    )}

    {data.problems && data.problems.length > 0 && (
      <ExerciseProblems problems={data.problems} />
    )}

    <section class="mt-6">
      <Content />
    </section>

    {lessonForExercise && (
      <div class="mt-10 pt-6 border-t">
        <a
          href={`/lessons/${lessonForExercise.slug}`}
          class="text-sm text-blue-700 hover:underline"
        >
          ‚Üê Back to lesson
        </a>
      </div>
    )}
  </article>
</DocsLayout>

