---
import DocsLayout from "../../layouts/DocsLayout.astro"
import { collectionNames } from "../../lib/collections"
import { getAllTags, type TagGroup } from "../../lib/getAllTags"

export async function getStaticPaths() {
  const groups = await getAllTags()

  return groups.map((group) => ({
    params: { tag: group.tag },
    props: group,
  }))
}

const props = Astro.props as TagGroup
const tag = props.tag
const entries = props.entries ?? []

if (!tag) {
  throw new Error("Tag not found")
}

const courses = entries.filter((e) => e.collection === collectionNames.courses)
const concepts = entries.filter((e) => e.collection === collectionNames.concepts)
const totalMatches = entries.length

const description = totalMatches
  ? `Entries tagged with "${tag}" on your-site.`
  : `There are no entries using the "${tag}" tag yet.`
---

<DocsLayout title={`Tag: ${tag}`} description={description}>
  <h1 class="text-2xl font-bold mb-2">Tag: {tag}</h1>
  <p class="text-gray-700 mb-6">
    {totalMatches > 0
      ? <>This tag appears in {courses.length} course{courses.length === 1 ? '' : 's'} and {concepts.length} concept{concepts.length === 1 ? '' : 's'}.</>
      : <>No courses or concepts use this tag yet.</>}
  </p>

  <section class="mt-6">
    <h2 class="text-lg font-semibold mb-3">Courses</h2>
    {courses.length ? (
      <ul class="list-disc ms-5 space-y-2">
        {courses.map((course) => (
          <li>
            <a class="underline" href={`/courses/${course.slug}/`}>
              {course.data.code ? `${course.data.code} â€” ` : ''}{course.data.title}
            </a>
            {course.data.description && (
              <p class="text-sm text-gray-600">{course.data.description}</p>
            )}
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-gray-500">No courses found for this tag.</p>
    )}
  </section>

  <section class="mt-8">
    <h2 class="text-lg font-semibold mb-3">Concepts</h2>
    {concepts.length ? (
      <ul class="list-disc ms-5 space-y-2">
        {concepts.map((concept) => (
          <li>
            <a class="underline" href={`/concepts/${concept.slug}/`}>
              {concept.data.title}
            </a>
            {concept.data.description && (
              <p class="text-sm text-gray-600">{concept.data.description}</p>
            )}
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-gray-500">No concepts found for this tag.</p>
    )}
  </section>
</DocsLayout>
