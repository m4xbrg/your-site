---
import DocsLayout from "../../../layouts/DocsLayout.astro"
import { getCollection } from 'astro:content'
import { collectionNames } from "../../../lib/collections"

export async function getStaticPaths() {
  const concepts = await getCollection(collectionNames.concepts)
  return concepts.map((concept) => {
    const slugParam = concept.slug.includes('/')
      ? concept.slug.split('/')
      : concept.slug

    return {
      params: { slug: slugParam },
      props: { concept },
    }
  })
}

const { concept } = Astro.props
if (!concept) throw new Error('Concept not found')
const { Content, data } = await concept.render()
const relatedSlugs = data.relatedConcepts ?? []
const allConcepts = relatedSlugs.length ? await getCollection(collectionNames.concepts) : []
const relatedConcepts = relatedSlugs.length
  ? relatedSlugs
      .map((slug) => allConcepts.find((entry) => entry.slug === slug))
      .filter(Boolean)
  : []
---
<DocsLayout title={data.title} description={data.description}>
  <article class="prose">
    <h1>{data.title}</h1>
    <Content />
  </article>
  {relatedConcepts.length > 0 && (
    <section class="mt-12">
      <h2 class="text-xl font-semibold mb-4">Related Concepts</h2>
      <ul class="grid gap-4 sm:grid-cols-2">
        {relatedConcepts.map((relatedConcept) => (
          <li>
            <a class="block rounded border border-gray-200 p-4 transition hover:border-brand-300 hover:bg-gray-50" href={`/concepts/${relatedConcept.slug}/`}>
              <p class="font-medium">{relatedConcept.data.title}</p>
              {relatedConcept.data.description && (
                <p class="text-sm text-gray-600 mt-1">{relatedConcept.data.description}</p>
              )}
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}
</DocsLayout>
