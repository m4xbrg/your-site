---
import DocsLayout from "../../layouts/DocsLayout.astro"
import { getCollection } from 'astro:content'
import { collectionNames } from "../../lib/collections"
import TagChips from "../../components/TagChips.astro"

export async function getStaticPaths() {
  const concepts = await getCollection(collectionNames.concepts)
  return concepts.map((concept) => {
    const slugParam = concept.slug.includes('/')
      ? concept.slug.split('/')
      : concept.slug
    const normalizedSlug = Array.isArray(slugParam)
      ? slugParam.join('/')
      : slugParam

    return {
      params: { slug: normalizedSlug },
      props: { concept },
    }
  })
}

const { concept } = Astro.props
if (!concept) throw new Error('Concept not found')

const { Content } = await concept.render()
const data = concept.data

const allConcepts = await getCollection(collectionNames.concepts)
const relatedSlugs = data.relatedConcepts ?? []
const relatedConcepts = relatedSlugs.length
  ? relatedSlugs
      .map((slug) =>
        allConcepts.find(
          (entry) => entry.slug === slug || entry.data.id === slug,
        ),
      )
      .filter(Boolean)
  : []

const difficultyLabel = data.difficulty
  ? `Difficulty: ${data.difficulty[0].toUpperCase()}${data.difficulty.slice(1)}`
  : undefined
const estimatedTimeLabel = data.estimatedTime
  ? `Estimated time: ${data.estimatedTime}`
  : undefined
const tagLabels = Array.isArray(data.tags) ? data.tags : []
const hasMetadata = Boolean(difficultyLabel || estimatedTimeLabel || tagLabels.length)

// NEW: wire concept → lessons/exercises
const allLessons = await getCollection(collectionNames.lessons)
const allExercises = await getCollection(collectionNames.exercises)

const resolvedPrerequisites = (data.prerequisites ?? []).map((slug) => {
  const conceptMatch = allConcepts.find(
    (entry) => entry.slug === slug || entry.data.id === slug,
  )
  if (conceptMatch) {
    return {
      title: conceptMatch.data.title,
      href: `/concepts/${conceptMatch.slug}/`,
    }
  }

  const lessonMatch = allLessons.find(
    (entry) => entry.slug === slug || entry.data.id === slug,
  )
  if (lessonMatch) {
    return {
      title: lessonMatch.data.title,
      href: `/lessons/${lessonMatch.slug}/`,
    }
  }

  return { title: slug }
})

// we use the explicit concept id if present; otherwise fall back to slug
const conceptKey = data.id ?? concept.slug

const lessonsForConcept = allLessons
  .filter((lesson) => {
    const list = lesson.data.concepts ?? []
    return Array.isArray(list) && list.includes(conceptKey)
  })
  .sort((a, b) => {
    const orderDiff = (a.data.order ?? 0) - (b.data.order ?? 0)
    if (orderDiff !== 0) return orderDiff
    return (a.data.title ?? '').localeCompare(b.data.title ?? '')
  })

const exercisesForConcept = allExercises
  .filter((exercise) => {
    const list = exercise.data.concepts ?? []
    return Array.isArray(list) && list.includes(conceptKey)
  })
  .sort((a, b) => (a.data.order ?? 0) - (b.data.order ?? 0))
---

<DocsLayout title={data.title} description={data.description}>
  <article class="prose">
    <h1>{data.title}</h1>
    <TagChips tags={data.tags ?? []} class="mb-6" />

    {hasMetadata && (
      <div class="mt-2 flex flex-wrap gap-2">
        {difficultyLabel && (
          <span class="rounded-full bg-slate-100 px-3 py-1 text-sm font-medium text-slate-700">
            {difficultyLabel}
          </span>
        )}
        {estimatedTimeLabel && (
          <span class="rounded-full bg-slate-100 px-3 py-1 text-sm font-medium text-slate-700">
            {estimatedTimeLabel}
          </span>
        )}
        {tagLabels.map((tag) => (
          <span
            class="rounded-full bg-slate-50 px-3 py-1 text-sm font-medium text-slate-600"
            key={tag}
          >
            {tag}
          </span>
        ))}
      </div>
    )}

    {Array.isArray(data.learningGoals) && data.learningGoals.length > 0 && (
      <section class="mb-8">
        <h2 class="text-lg font-semibold mb-3">Learning goals</h2>
        <ul class="list-disc pl-5 space-y-1">
          {data.learningGoals.map((goal) => (
            <li>{goal}</li>
          ))}
        </ul>
      </section>
    )}

    {resolvedPrerequisites.length > 0 && (
      <section class="mb-8">
        <h2 class="text-lg font-semibold mb-3">Prerequisites</h2>
        <ul class="list-disc pl-5 space-y-1">
          {resolvedPrerequisites.map((item) => (
            <li>
              {item.href ? (
                <a class="text-brand-600 hover:underline" href={item.href}>
                  {item.title}
                </a>
              ) : (
                <span>{item.title}</span>
              )}
            </li>
          ))}
        </ul>
      </section>
    )}

    <Content />

    {lessonsForConcept.length > 0 && (
      <section class="mt-10">
        <h2 class="text-lg font-semibold mb-3">Used in lessons</h2>
        <ul class="space-y-2 text-sm">
          {lessonsForConcept.map((lesson) => (
            <li>
              <a
                href={`/lessons/${lesson.slug}/`}
                class="flex flex-col rounded-lg border border-gray-200 px-3 py-2 hover:bg-gray-50 transition"
              >
                <span class="font-medium text-gray-900">
                  {lesson.data.title}
                </span>
                <span class="text-xs uppercase tracking-wide text-gray-500">
                  Lesson {lesson.data.order ?? '—'}
                </span>
                {lesson.data.description && (
                  <span class="text-gray-600">
                    {lesson.data.description}
                  </span>
                )}
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    {exercisesForConcept.length > 0 && (
      <section class="mt-8">
        <h2 class="text-lg font-semibold mb-3">Practice for this concept</h2>
        <ul class="space-y-2 text-sm">
          {exercisesForConcept.map((ex) => (
            <li>
              <a
                href={`/exercises/${ex.slug}/`}
                class="flex flex-col rounded-lg border border-gray-200 px-3 py-2 hover:bg-gray-50 transition"
              >
                <span class="font-medium text-gray-900">
                  {ex.data.title}
                </span>
                {ex.data.status && (
                  <span class="text-xs text-gray-500">
                    {ex.data.status === "draft" ? "Draft" : "Exercises"}
                  </span>
                )}
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}
  </article>

  {relatedConcepts.length > 0 && (
    <section class="mt-12">
      <h2 class="text-xl font-semibold mb-4">Related Concepts</h2>
      <ul class="grid gap-4 sm:grid-cols-2">
        {relatedConcepts.map((relatedConcept) => (
          <li>
            <a
              class="block rounded border border-gray-200 p-4 transition hover:border-brand-300 hover:bg-gray-50"
              href={`/concepts/${relatedConcept.slug}/`}
            >
              <p class="font-medium">{relatedConcept.data.title}</p>
              {relatedConcept.data.description && (
                <p class="text-sm text-gray-600 mt-1">
                  {relatedConcept.data.description}
                </p>
              )}
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}
</DocsLayout>
