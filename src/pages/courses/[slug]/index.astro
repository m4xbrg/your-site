---
import DocsLayout from "../../../layouts/DocsLayout.astro"
import { getCollection } from 'astro:content'
import { collectionNames } from "../../../lib/collections"

const sortByOrder = (a,b) => (a.data.order ?? 0) - (b.data.order ?? 0)
const formatDifficulty = (difficulty) =>
  typeof difficulty === 'string'
    ? `${difficulty.charAt(0).toUpperCase()}${difficulty.slice(1)}`
    : ''

export async function getStaticPaths() {
  const [courses, concepts] = await Promise.all([
    getCollection(collectionNames.courses),
    getCollection(collectionNames.concepts),
  ])

  return courses.map((course) => ({
    params: { slug: course.slug },
    props: {
      course,
      concepts: concepts
        .filter((concept) => concept.data.course === course.slug)
        .slice()
        .sort(sortByOrder),
    },
  }))
}

const { course, concepts } = Astro.props
if (!course) throw new Error('Course not found')
---
<DocsLayout title={course.data.title} description={course.data.description}>
  <h1 class="text-2xl font-bold mb-2">{course.data.code} â€” {course.data.title}</h1>
  {course.data.description && <p class="text-gray-700 mb-4">{course.data.description}</p>}
  <div class="flex flex-wrap gap-2 mb-6">
    {course.data.difficulty && (
      <span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700">
        Difficulty: {formatDifficulty(course.data.difficulty)}
      </span>
    )}
    {course.data.estimatedTime && (
      <span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700">
        Estimated time: {course.data.estimatedTime}
      </span>
    )}
    {Array.isArray(course.data.tags) &&
      course.data.tags.map((tag) => (
        <span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700">
          {tag}
        </span>
      ))}
  </div>
  {Array.isArray(course.data.learningGoals) && course.data.learningGoals.length > 0 && (
    <div class="mb-6">
      <h3 class="text-lg font-semibold mb-2">Learning goals</h3>
      <ul class="list-disc ms-5 space-y-1 text-gray-700">
        {course.data.learningGoals.map((goal) => (
          <li>{goal}</li>
        ))}
      </ul>
    </div>
  )}
  <h2 class="text-lg font-semibold mt-8 mb-3">Concepts in this course</h2>
  <ul class="list-disc ms-5">
    {concepts.map(k => <li><a class="underline" href={`/concepts/${k.slug}/`}>{k.data.title}</a></li>)}
  </ul>
</DocsLayout>
