---
import DocsLayout from "../../../layouts/DocsLayout.astro"
import { getCollection } from 'astro:content'

const sortByOrder = (a,b) => (a.data.order ?? 0) - (b.data.order ?? 0)

export async function getStaticPaths() {
  const [subjects, courses, concepts] = await Promise.all([
    getCollection('subjects'),
    getCollection('courses'),
    getCollection('concepts'),
  ])

  return subjects.map((subject) => {
    const relatedCourses = courses
      .filter((course) => course.data.subject === subject.slug)
      .slice()
      .sort(sortByOrder)
    const relatedConcepts = concepts
      .filter((concept) => concept.data.subject === subject.slug)
      .slice()
      .sort(sortByOrder)

    return {
      params: { slug: subject.slug },
      props: {
        subject,
        courses: relatedCourses,
        concepts: relatedConcepts,
      },
    }
  })
}

const { subject, courses, concepts } = Astro.props
if (!subject) throw new Error('Subject not found')
---
<DocsLayout title={subject.data.title} description={subject.data.description}>
  <h1 class="text-2xl font-bold mb-2">{subject.data.title}</h1>
  {subject.data.description && <p class="text-gray-700 mb-6">{subject.data.description}</p>}
  <h2 class="text-lg font-semibold mt-8 mb-3">Courses</h2>
  <ul class="list-disc ms-5">
    {courses.map(c => <li><a class="underline" href={`/courses/${c.data.id}/`}>{c.data.code} â€” {c.data.title}</a></li>)}
  </ul>
  <h2 class="text-lg font-semibold mt-8 mb-3">Concepts</h2>
  <ul class="list-disc ms-5 space-y-2">
    {concepts.map(k => (
      <li>
        <a class="underline" href={`/concepts/${k.slug}/`}>{k.data.title}</a>
        {k.data.description && <p class="text-sm text-gray-600">{k.data.description}</p>}
      </li>
    ))}
  </ul>
</DocsLayout>
